require.config({
	paths : {
		"jquery" : "jquery-1.11.3",
		"cookie" : "jquery.cookie"
	}
})

//封装模块
require(['jquery','cookie'],function($,cookie){
	//显示商品
	var $gsbox = $('#gsbox');
	var $smallPic = $('#gsbox .smallPic'); 
	var $mark = $('#gsbox .smallPic .mark');
	var $float = $('#gsbox .smallPic .float')
	var $bigPic = $('#gsbox .bigPic');
	var $bigImg = $('#gsbox .bigPic img');
	$mark.on({
		'mouseenter' : function(){
			$float.animate({
				'opacity' : 0.7
			},500)
//			$float.css('display','block');
			$bigPic.css('display','block');
			$bigPic.animate({
				'opacity' : 1,
			},500)
		},
		'mouseleave' : function(){
			$float.animate({
				'opacity' : 0
			},500)
//			$float.css('display','none');
			$bigPic.css('display','none');
			$bigPic.animate({
				'opacity' : 0
			},500)
		},
		'mousemove' : function(evt){
			var l = evt.pageX - $gsbox.offset().left - $float.width() / 2;
			var t = evt.pageY - $gsbox.offset().top - $float.height() / 2;
			if(l <= 0){
				l = 0;
			}else if(l >= $smallPic.width() - $float.width()){
				l = $smallPic.width() - $float.width();
			}
			if(t <= 0){
				t = 0;
			}else if(t >= $smallPic.height() - $float.height()){
				t = $smallPic.height() - $float.height();
			}
			$float.css({'left' : l + 'px','top' : t + 'px'});
			
			//求小图移动比例
			var pX = l / ($smallPic.width() - $float.width());
			var pY = t / ($smallPic.height() - $float.height());
			
			//大图设置移动
			$bigImg.css({'left' : -pX * ($bigImg.width() - $bigPic.width()) + 'px','top' : -pY * ($bigImg.height() - $bigPic.height()) + 'px'})
		}
	})
	//划过换照片
	function Slide(id){
		this.liImg = $('#gsbox .ull li');
		this.num = this.liImg.length;
		this.smallAll = $('#gsbox .smallPic img');
		this.bigAll = $('#gsbox .bigPic img');
		this.indexA = 0;
		this.sport();
		this.addEvent();
	}
	Slide.prototype = {
		sport : function(){
			for(var i = 0;i < this.num;i ++){
				this.liImg[i].style.border = '2px solid #fff';
				this.smallAll[i].style.display = 'none';
				this.bigAll[i].style.display = 'none';
			}
			this.liImg[this.indexA].style.border = '2px solid red';
			this.smallAll[this.indexA].style.display = 'block';
			this.bigAll[this.indexA].style.display = 'block';
		},
		addEvent : function(){
			var that = this;
			for(var i = 0;i < this.num;i ++){
				this.liImg[i].index = i;
				this.liImg[i].onmouseenter = function(){
					that.indexA = this.index;
					that.sport();
				}
			}
		}
	}
	$(function(){
		new Slide(gsbox);
	})
	
	
	//倒计时
 	setInterval(function(){
 		var startDate2 = new Date();
		var endDate2 = new Date("2018/09/05 23:59:59");
		var lasttime = (endDate2.getTime() - startDate2.getTime()) / 1000;
		var t = parseInt(lasttime / 60 / 60 / 24);
		var h = parseInt(lasttime / 60 / 60 % 24);
		var f = parseInt(lasttime / 60 % 60);
		var m = parseInt(lasttime % 60);
		var str = t + '天' + ' ' + h + ':' +  f + ':' + m;
 		$('#pmstime').html(str);
 	},1000);
 	
 	
 	//购物车
	$('.cart_info_right').click(function(){
		location.href = 'cart.html';
	})
	
	$("#addToCart").click(function(){
		location.href = 'cart.html';
	})
	
	var num = parseInt($('.num').val());
	$(".minus").click(function(){
		if(num > 1){
			num --;
		}
		$('.num').val(num);
	})
	$(".add").click(function(){
		num ++;
		$('.num').val(num);
	})
	$('.num').blur(function(){
		if(/^\d+$/.test(num) && num > 0){
			$('.num').val(num);
		}else{
			num = 1;
			$('.num').val(num);
		}
	})
	
	
	$(function(){
		var cartStr = $.cookie('mycart') ? $.cookie('mycart') : "";
		if(!cartStr){
			$('.blank').css('display','block');
		}else{
			$('.blank').css('display','none');
			var cartObj = convertcartStrTocartObj(cartStr);
			for(var id in cartObj){
				var good = cartObj[id];
				var str = `
					<tr data-good-id='${good.id}'>
						<td width="60px" height="40"><img src='${good.src}' alt='' style='width:30px;height:30px;margin-left:20px;'/></td>
						<td width="250px" align="center">${good.name}</td>
						<td width="100px" style='padding-left:20px;color:red;'>${good.price} x ${good.num}</td>
					</tr>
				`;
				$('#tab').append(str);
				var num = 0;
				for(var i in cartObj){
					num += cartObj[i].num;
				}
				$('.sbuy').html(`购物车中有${num}件商品`);
				$('.sum').html(`￥${good.price * num}`);
				$('#buy').html(`购物车${num}件`);
			}
		}
	})
	function convertcartStrTocartObj(str){
		if(!str){
			return {};
		}
		return JSON.parse(str);
	}
	
})