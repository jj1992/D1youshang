require.config({
	paths : {
		"jquery" : "jquery-1.11.3",
		"cookie" : "jquery.cookie"
	}
})

//封装模块
require(['jquery','cookie'],function($,cookie){
	
	$(function(){
		$('.li1').click(function(){
			location.href = 'detail.html';
		})
		$('.cart_info_right').click(function(){
			location.href = 'cart.html';
		})
		$('.buy_list').mouseenter(function(){
			 window.location.reload();
		})
	})
	
	
	
	//加入购物车
	
	$(function(){
		myInit();
		//给加入购物车按钮添加点击事件
		$(".rl_gds .addToCart").click(function(){
			
			//获取商品id
			var gsId = $(this).parent().parent().parent().attr("data-good-id");
			var gsName = $(this).parent().parent().siblings('.g_title').children('.g_name').find('a').attr('title');
			var gsPrice = parseFloat($(this).parent().parent().siblings('.g_price').children('.g_mprice').find('font').html());
			var gsSrc = $(this).parent().parent().siblings('.g_sing').find('a').children('img').attr('src');
			
			var cartStr = $.cookie('mycart') ? $.cookie('mycart') : "";
			var cartObj = convertcartStrTocartObj(cartStr);
			if(gsId in cartObj){
				cartObj[gsId].num ++;
			}else{
				cartObj[gsId] = {
					"name" : gsName,
					"price" : gsPrice,
					"src" : gsSrc,
					"num" : 1
				}
			}
			//重新加入cookie
			$.cookie('mycart',JSON.stringify(cartObj),{expires : 7,path : '/'});
			myInit();
			console.log($.cookie('mycart'));

			return false;
			
		})
	})
	function convertcartStrTocartObj(str){
		if(!str){
			return {};
		}
		return JSON.parse(str);
	}
	
	function myInit(){
		var cartStr = $.cookie('mycart') ? $.cookie('mycart') : "";
		if(!cartStr){
			$('.blank').css('display','block');
		}else{
			$('.blank').css('display','none');
			var cartObj = convertcartStrTocartObj(cartStr);
			for(var id in cartObj){
				var good = cartObj[id];
				var str = `
					<tr data-good-id='${good.id}'>
						<td width="60px" height="40"><img src='${good.src}' alt='' style='width:30px;height:30px;margin-left:20px;'/></td>
						<td width="250px" align="center">${good.name}</td>
						<td width="100px" style='padding-left:20px;color:red;'>${good.price} x ${good.num}</td>
					</tr>
				`;
				$('#tab').append(str);
				var num = 0;
				for(var i in cartObj){
					num += cartObj[i].num;
				}
				$('.sbuy').html(`购物车中有${num}件商品`);
				$('.sum').html(`￥${good.price * num}`);
				
				$('#buy').html(`购物车${num}件`);
			}
		}
	}
})