require.config({
	paths : {
		"jquery" : "jquery-1.11.3",
		"cookie" : "jquery.cookie"
	}
})

//封装模块
require(['jquery','cookie'],function($,cookie){
	
	$(function(){
		//取出cookie中存的购物车信息
		var cartStr = $.cookie('mycart') ? $.cookie('mycart') : "";
		if(!cartStr){
			$('.noCart').css('display','block');
			$('#total_area').css('display','none');
			$('#check_btn_area').css('display','none');
		}else{
			$('#total_area').css('display','block');
			$('#check_btn_area').css('display','block');
			var cartObj = convertcartStrTocartObj(cartStr);
			//遍历对象
			for(var id in cartObj){
				var good = cartObj[id];
				var str = `
					<tr id="cart_1" type='20' style="background: #fffddd;" data-good-id="${id}">
						<td class="cart1" height="100">
							<a href="#" title="【秒杀】日本进口 不锈钢菜刀 多功能轻便水果刀（水果刀+磨刀石 套装）">
								<img src="${good.src}" alt="【秒杀】日本进口 不锈钢菜刀 多功能轻便水果刀（水果刀+磨刀石 套装）" />
							</a>
						</td>
						<td class="othertd">
							${good.name}
							<br>
							01207894
							<br>
							<a href="javascript:;" class="del_link">删除</a>
							<a href="javascript:;" class="fav_link">加入收藏</a>
						</td>
						<td>
							无
						</td>
						<td>
							<span>${good.price}</span>
						</td>
						<td>${good.price}</td>
						<td>
							<a class="num_minus" href="javascript:;" title="减1">
								<img src="../img/cart/j_a.gif" alt="" />
							</a>
							<input id="num_input" class="amount" type="text" value="${good.num}"/>
							<a class="num_add" href="javascript:;" title="加1">
								<img src="../img/cart/a_j.gif" alt="" />
							</a>
						</td>
						<td>
							<font color="#ff0000">${good.price * good.num}</font>
						</td>
					</tr>
				`;
				$('#tal').append(str);
				
				var num = 0;
				for(var i in cartObj){
					num += cartObj[i].num;
				}
				$('#total_area').find('#total_Count').html(num);
				$('#total_area').find('#total_Price').html( (good.price * num) );
			}
		}
		
			//删除
			$('.othertd .del_link').click(function(){
				//删除页面中指定商品，返回该商品的ID
				var id = $(this).parents('#cart_1').remove().attr('data-good-id');
				//获取cookie
				var cartStr = $.cookie('mycart') ? $.cookie('mycart') : "";
				//转为对象
				var cartObj = convertcartStrTocartObj(cartStr);
				delete cartObj[id] //删除对象中指定的key
				//添加到cookie
				$.cookie('mycart',JSON.stringify(cartObj),{expires : 7,path : '/'});
//				console.log(cartObj);
				init();
				})
			//减
			$('#cart_1 .num_minus').click(function(){
				var id = $(this).parents('#cart_1').attr('data-good-id');
				//获取cookie
				var cartStr = $.cookie('mycart') ? $.cookie('mycart') : "";
				//转为对象
				var cartObj = convertcartStrTocartObj(cartStr);
				if(cartObj[id].num > 1){
					cartObj[id].num --; // 当前商品数量减1
					//添加到cookie
					$.cookie('mycart',JSON.stringify(cartObj),{expires : 7,path : '/'});
					//数量的文本框的值发生变化
					$(this).next().val(cartObj[id].num);
					//合计发生变化
					$(this).parent().next().html(cartObj[id].price * cartObj[id].num);
					init();
				}
			})
			//加
			$('#cart_1 .num_add').click(function(){
				var id = $(this).parents('#cart_1').attr('data-good-id');
				//获取cookie
				var cartStr = $.cookie('mycart') ? $.cookie('mycart') : "";
				//转为对象
				var cartObj = convertcartStrTocartObj(cartStr);
				cartObj[id].num ++;
				//添加到cookie
				$.cookie('mycart',JSON.stringify(cartObj),{expires : 7,path : '/'});
				//数量的文本框的值发生变化
				$(this).prev().val(cartObj[id].num);
				//合计发生变化
				$(this).parent().next().html(cartObj[id].price * cartObj[id].num);
				init();
			})
			//数量文本框
			$('#num_input').blur(function(){
				var id = $(this).parents('#cart_1').attr('data-good-id');
				//获取cookie
				var cartStr = $.cookie('mycart') ? $.cookie('mycart') : "";
				//转为对象
				var cartObj = convertcartStrTocartObj(cartStr);
				var num = parseInt($(this).val());
				if(/^\d+$/.test(num) && num > 0){
					cartObj[id].num = num;
				}else{
					cartObj[id].num = 1;
				}
				//添加到cookie
				$.cookie('mycart',JSON.stringify(cartObj),{expires : 7,path : '/'});
				//数量的文本框的值发生变化
				$(this).val(cartObj[id].num);
				//合计发生变化
				$(this).parent().next().html(cartObj[id].price * cartObj[id].num);
				init();
			})
		
	})
	function init(){
		var cartStr = $.cookie('mycart') ? $.cookie('mycart') : "";
		var cartObj = convertcartStrTocartObj(cartStr);
		//获取到购物车所有商品的数量
		var num = 0;
		var total =0
		for(var i in cartObj){
			num += cartObj[i].num;
			total += cartObj[i].num * cartObj[i].price;
		}
		$('#total_area').find('#total_Count').html(num);
		$('#total_area').find('#total_Price').html( total );
	}
	function convertcartStrTocartObj(str){
		if(!str){
			return {};
		}
		return JSON.parse(str);
	}
	
	$("#checkout").click(function(){
		location.href = 'login.html';
		alert('没钱，还是先别买了！');
	})
})